#!/usr/bin/env node

'use strict';

var rfr = require('rfr');
var args = require('yargs').argv;
var chokidar = require('chokidar');
var bs = require('browser-sync').create();
var _ = require('lodash');
var path = require('path');
var stylemark = rfr('src/stylemark');

var input = args.i;
var output = args.o;
var configPath = args.c;
var watch = args.w;
var delay = (watch === true) ? 2000 : watch;
var browser = args.b;
var port = _.isNumber(browser) ? browser : null;

var fs = require('fs');
var yaml = require('js-yaml');
var configPath = configPath ? path.resolve(configPath) : path.resolve(input, '.stylemark.yml');
var configOptions = getConfig(configPath);
const fileWatchOptions = configOptions.fileWatchOptions;
const browserSyncOptions = configOptions.browserSyncOptions;
//console.log({configOptions});

function getConfig(filepath) {
	if (!fs.existsSync(filepath)) {
		return {};
	}
	var contents = fs.readFileSync(filepath, 'utf8');
	var config = yaml.safeLoad(contents);
	return config;
}

var generate = _.throttle(
	function() {
		console.log('Generating style guide...');
		stylemark({
			input: input,
			output: output,
			configPath: configPath,
		});
	},
	delay
);

generate();

if (watch) {
	console.log('Watching for changes...');

	// Use fileWatch from config file, or fallback to input
	const fileWatchPaths = configOptions.fileWatchPaths || input;
	//console.log(fileWatchOptions); // TODO: verify
	var watcher = chokidar.watch(fileWatchPaths, {
		ignoreInitial: true,
		persistent: true,
		...fileWatchOptions
	});

	watcher.on('all', function(event, path) {
		console.log(event, path);
		generate();
	});
}

if (browser) {
	console.log('Launching browser...');
	var options = {
		ui: false,
		files: path.resolve(output, '**', '*.*'),
		watchEvents: ['add', 'change'],
		server: output,
		reloadDelay: 500,
		notify: false,
		ghostMode: false,  // ghost mode causes cross-iframe weirdness
		...browserSyncOptions
	};
	if (port) {
		options.port = port;
	}
	//console.log({options});
	bs.init(options);
}
